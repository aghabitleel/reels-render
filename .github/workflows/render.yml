name: Render Reel

on:
  repository_dispatch:
    types: [render_reel]

jobs:
  render:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Download videos
        run: |
          echo "Video URLs: ${{ toJSON(github.event.client_payload.video_urls) }}"
          
          # Parse JSON array and download each video
          echo '${{ toJSON(github.event.client_payload.video_urls) }}' | jq -r '.[]' | while IFS= read -r url; do
            index=$((index + 1))
            echo "Downloading video $index from: $url"
            curl -L -o "in_${index}.mp4" "$url" || echo "Failed to download $url"
          done
          
          # List downloaded files
          ls -lh in_*.mp4
      
      - name: Download audio
        run: |
          echo "Downloading audio from: ${{ github.event.client_payload.audio_url }}"
          curl -L -o "audio.mp3" "${{ github.event.client_payload.audio_url }}"
          ls -lh audio.mp3
      
      - name: Normalize videos to vertical format
        run: |
          if ls in_*.mp4 1> /dev/null 2>&1; then
            for f in in_*.mp4; do
              out="norm_${f#in_}"
              echo "Processing $f -> $out"
              
              # Scale and crop to 1080x1920 (9:16 aspect ratio)
              ffmpeg -i "$f" \
                -vf "scale=1080:1920:force_original_aspect_ratio=increase,crop=1080:1920" \
                -an \
                -c:v libx264 -preset fast -crf 23 \
                -y "$out"
            done
          else
            echo "No video files found!"
            exit 1
          fi
          
          # List processed files
          ls -lh norm_*.mp4
      
      - name: Create concat list
        run: |
          for f in norm_*.mp4; do
            echo "file '$f'" >> concat.txt
          done
          echo "Concat list:"
          cat concat.txt
      
      - name: Concatenate videos
        run: |
          ffmpeg -f concat -safe 0 -i concat.txt \
            -c copy \
            -y concatenated.mp4
          
          ls -lh concatenated.mp4
      
      - name: Add audio to video
        run: |
          output_name="${{ github.event.client_payload.out_name }}"
          
          ffmpeg -i concatenated.mp4 -i audio.mp3 \
            -c:v copy \
            -c:a aac -b:a 192k \
            -map 0:v:0 -map 1:a:0 \
            -shortest \
            -y "$output_name"
          
          echo "Final output:"
          ls -lh "$output_name"
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: rendered-reel
          path: ${{ github.event.client_payload.out_name }}
          retention-days: 7
